---
title: "RF21: Usuario consulta fórmulas."  
sidebar_position: 22
---

# RF21: Usuario consulta fórmulas

### Historia de Usuario

Yo como usuario quiero poder consultar las fórmulas que previamente fueron definidas para conocer las que podré aplicar a los datos que usaré en la generación de reportes.

  **Dependencias:**
  - US 14: Usuario selecciona datos a comparar en el análisis.

  **Criterios de Aceptación:**
  - El sistema debe mostrar al usuario el listado de fórmulas previamente guardadas de manera clara y accesible.
  - El sistema debe notificar visualmente al usuario en caso de que ocurra cualquier error durante la consulta de las fórmulas, indicando el motivo del error.
  - El sistema debe manejar adecuadamente los casos en los que no existan fórmulas guardadas, mostrando un mensaje informativo al usuario.

---

### Diagrama de Secuencia

> *Descripción*: Los diagramas de secuencia muestran cómo, una vez que el usuario ha seleccionado los datos a analizar, el sistema consulta las fórmulas previamente definidas. Si la consulta es exitosa, se devuelve el listado de fórmulas disponibles; si falla, se muestra un mensaje de error.

#### Primera Parte (Electron)
```mermaid
sequenceDiagram
    actor Usuario
    participant vistaFormulas as Interfaz "Formulas"
    participant utilFormulas as consultarFormulas.js
    participant backend as cargarExcel.js

    activate Usuario
    Usuario->>vistaFormulas: Click en "Consultar Fórmulas"
    activate vistaFormulas
    vistaFormulas->>utilFormulas: consultarFormulas()
    utilFormulas->>backend: leerExcel()
    activate backend
    alt Consulta exitosa
        rect Lightgreen
        backend-->>utilFormulas: { exito: true, datos }
        utilFormulas-->>vistaFormulas: Renderiza datos de fórmulas
        vistaFormulas-->>Usuario: Muestra fórmulas consultadas
        end
    else Archivo no válido o inseguro
        rect Lightcoral
        backend-->>utilFormulas: { exito: false, mensaje }
        utilFormulas-->>vistaFormulas: Muestra alerta de error
        vistaFormulas-->>Usuario: Muestra mensaje de error
        end
    else Error inesperado
        rect Lightcoral
        backend--x utilFormulas: Excepción/Error
        utilFormulas-->>vistaFormulas: Muestra alerta de error
        vistaFormulas-->>Usuario: Muestra mensaje de error
        end
    end
    deactivate backend
    deactivate vistaFormulas
    deactivate Usuario
```

#### Segunda Parte (Backend Desacoplado)
```mermaid
sequenceDiagram
    participant UI as Electron
    participant app as app.js
    participant ruta as formulas/rutas/consultarFormulas.ruta.js
    participant middleware1 as util/middlewares/middlewareAutenticacion.js
    participant middleware2 as util/middlewares/middlewarePermisos.js
    participant middleware3 as util/middlewares/middlewarePermisos.js (checarPermisos)
    participant controlador as formulas/controladores/consultarFormulaControlador.js
    participant repo as formulas/data/repositorios/consultarFormulaRepositorio.js
    participant modelo as formulas/data/modelos/consultarFormulaModelo.js
    participant bd as util/servicios/bd.js

    UI->>app: GET /formulas/consultarFormulas
    app->>ruta: /consultarFormulas
    ruta->>middleware1: verificarToken
    alt Token inválido
        rect Lightcoral
        middleware1-->>ruta: 401 { mensaje: "Token no válido" }
        ruta-->>app: 401
        app-->>UI: Muestra error de autenticación
        end
    else Token válido
        middleware1->>middleware2: verificarPermisos
        alt Permisos insuficientes
            rect Lightcoral
            middleware2-->>ruta: 403 { mensaje: "No tienes permisos para realizar esta acción" }
            ruta-->>app: 403
            app-->>UI: Muestra error de permisos
            end
        else Permisos correctos
            middleware2->>middleware3: checarPermisos('PUEDEVER')
            alt No tiene permiso PUEDEVER
                rect Lightcoral
                middleware3-->>ruta: 404 { message: "Página no encontrada" }
                ruta-->>app: 404
                app-->>UI: Muestra error de permisos
                end
            else Tiene permiso PUEDEVER
                middleware3->>controlador: consultarFormula
                controlador->>repo: consultarFormulaRepositorio
                repo->>modelo: consultarFormulaModelo
                modelo->>bd: SELECT * FROM formula
                alt Consulta exitosa y hay datos
                    rect Lightgreen
                    bd-->>modelo: Resultados
                    modelo-->>repo: Resultados
                    repo-->>controlador: Resultados
                    controlador-->>ruta: { datos }
                    ruta-->>app: 200 { mensaje: "Fórmulas consultadas con éxito", datos }
                    app-->>UI: Muestra lista de fórmulas
                    end
                else No hay fórmulas
                    rect Lightcoral
                    bd-->>modelo: []
                    modelo-->>repo: []
                    repo-->>controlador: []
                    controlador-->>ruta: 500 { mensaje: "Error al consultar las fórmulas: no se encontraron fórmulas" }
                    ruta-->>app: 500
                    app-->>UI: Muestra error de "no se encontraron fórmulas"
                    end
                else Error inesperado
                    rect Lightcoral
                    bd--x modelo: Excepción/Error
                    modelo--x repo: Error
                    repo--x controlador: Error
                    controlador-->>ruta: 500 { mensaje: "Error de conexión, intente más tarde" }
                    ruta-->>app: 500
                    app-->>UI: Muestra error de servidor
                    end
                end
            end
        end
    end
```

---

### Mockup

![Mockup](./mockups/MockupFormulas.png)

> *Descripción*: El mockup representa la interfaz del sistema donde el usuario puede consultar la página de consultar formulas. 


---

### Link Pruebas

[Pruebas](https://docs.google.com/spreadsheets/d/1W-JW32dTsfI22-Yl5LydMhiu-oXHH_xo3hWvK6FHeLw/edit?gid=1978361660#gid=1978361660)
---

### Pull Request
[https://github.com/CodeAnd-Co/App-Local-TracTech/pull/62](https://github.com/CodeAnd-Co/App-Local-TracTech/pull/62)
