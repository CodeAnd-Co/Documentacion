---
title: "RF24: Usuario define fórmula"  
sidebar_position: 25
---

# RF24: Usuario define fórmula"

### Historia de Usuario

Yo como usuario quiero definir mis propias fórmulas para utilizarlas en los reportes.

  **Criterios de Aceptación:**
  - El sistema debe mantener las fórmulas accesibles.
  - El sistema debe permitir al usuario generar fórmulas simples y complejas.

---

### Diagrama de Secuencia

#### Primera Parte (Electron)

![Diagrama de Secuencia] 

```mermaid

```
#### Segunda Parte (Backend Desacoplado)

```mermaid
sequenceDiagram
    actor Usuario
    participant UI as Electron
    participant app as app.js
    participant ruta as formulas/rutas/definirFormula.ruta.js
    participant middleware1 as util/middlewares/middlewareAutenticacion.js
    participant middleware2 as util/middlewares/middlewarePermisos.js
    participant controlador as formulas/controladores/definirFormulaControlador.js
    participant repo as formulas/data/repositorios/definirFormulaRepositorio.js
    participant modelo as formulas/data/modelos/definirFormulaModelo.js
    participant bd as util/servicios/bd.js

    activate Usuario
    Usuario->>UI: Click en "Definir fórmula"
    activate UI
    UI->>app: POST /formulas/definirFormula (datos fórmula)
    app->>ruta: /definirFormula
    ruta->>middleware1: verificarToken
    alt Token inválido
        rect Lightcoral
        middleware1-->>ruta: 401 { mensaje: "Token no válido" }
        ruta-->>app: 401
        app-->>UI: Muestra error de autenticación
        UI-->>Usuario: Mensaje de error
        end
    else Token válido
        middleware1->>middleware2: verificarPermisos
        alt Permisos insuficientes
            rect Lightcoral
            middleware2-->>ruta: 403 { mensaje: "No tienes permisos para realizar esta acción" }
            ruta-->>app: 403
            app-->>UI: Muestra error de permisos
            UI-->>Usuario: Mensaje de error
            end
        else Permisos correctos
            middleware2->>controlador: definirFormula (datos)
            controlador->>repo: definirFormulaRepositorio (datos)
            repo->>modelo: definirFormulaModelo (datos)
            modelo->>bd: INSERT INTO formula ...
            alt Definición exitosa
                rect Lightgreen
                bd-->>modelo: { ok: true, id }
                modelo-->>repo: { ok: true, id }
                repo-->>controlador: { ok: true, id }
                controlador-->>ruta: { ok: true, mensaje: "Fórmula definida con éxito" }
                ruta-->>app: 200 { ok: true, mensaje }
                app-->>UI: Muestra mensaje de éxito
                UI-->>Usuario: Mensaje de éxito
                end
            else Error de validación o negocio
                rect Lightcoral
                bd-->>modelo: { ok: false, mensaje }
                modelo-->>repo: { ok: false, mensaje }
                repo-->>controlador: { ok: false, mensaje }
                controlador-->>ruta: 400 { ok: false, mensaje }
                ruta-->>app: 400
                app-->>UI: Muestra mensaje de error
                UI-->>Usuario: Mensaje de error
                end
            else Error inesperado
                rect Lightcoral
                bd--x modelo: Excepción/Error
                modelo--x repo: Error
                repo--x controlador: Error
                controlador-->>ruta: 500 { ok: false, mensaje: "Error de servidor" }
                ruta-->>app: 500
                app-->>UI: Muestra mensaje de error
                UI-->>Usuario: Mensaje de error
                end
            end
        end
    end
    deactivate UI
    deactivate Usuario
```

### Mockup

![Mockup](./mockups/MockupCrearFormula.png)


### Pruebas Unitarias 

#### [https://docs.google.com/spreadsheets/d/1W-JW32dTsfI22-Yl5LydMhiu-oXHH_xo3hWvK6FHeLw/edit?gid=1643463360#gid=1643463360](https://docs.google.com/spreadsheets/d/1W-JW32dTsfI22-Yl5LydMhiu-oXHH_xo3hWvK6FHeLw/edit?gid=1643463360#gid=1643463360)
---

### Pull Request
[https://github.com/CodeAnd-Co/App-Local-TracTech/pull/38](https://github.com/CodeAnd-Co/App-Local-TracTech/pull/38)
