---
title: "RF24: Usuario define fórmula"  
sidebar_position: 25
---

# RF24: Usuario define fórmula

### Historia de Usuario

Yo como usuario quiero definir mis propias fórmulas para utilizarlas en los reportes.

  **Criterios de Aceptación:**
  - El sistema debe permitir al usuario crear y guardar fórmulas personalizadas, tanto simples como complejas.
  - Las fórmulas definidas deben estar siempre accesibles para su consulta, edición y reutilización.
  - El sistema debe validar la unicidad y el formato de las fórmulas antes de guardarlas, mostrando mensajes claros en caso de error.
  - El usuario debe recibir retroalimentación visual sobre el éxito o fallo en la creación y almacenamiento de fórmulas.

---

### Diagrama de Secuencia

#### Primera Parte (Electron)

![Diagrama de Secuencia] 

```mermaid
sequenceDiagram
    actor Usuario
    participant vistaCrear as Interfaz "crearFormula"
    participant utilCrear as crearFormula.js
    participant backend as crearFormula.js (backend)

    activate Usuario
    Usuario->>vistaCrear: Ingresa a "Crear Fórmula"
    activate vistaCrear
    vistaCrear->>utilCrear: inicializarCrearFormula()
    utilCrear->>utilCrear: Verifica archivo Excel cargado
    alt No hay archivo cargado
        rect Lightcoral
        utilCrear-->>vistaCrear: Deshabilita botones, muestra error
        vistaCrear-->>Usuario: Muestra mensaje "No hay archivo cargado"
          end
    else Hay archivo cargado
        utilCrear-->>vistaCrear: Habilita UI para crear fórmula
        Usuario->>vistaCrear: Llena campos y selecciona función/argumentos
        vistaCrear->>utilCrear: popularDropdown(), definirEstructura(), agregarArgumento(), agregarCriterio(), agregarFuncionAnidada(), etc.
        Usuario->>vistaCrear: Click en "Previsualizar"
        vistaCrear->>utilCrear: generarFormulaCompleja()
        alt Campos incompletos o inválidos
            rect Lightcoral
            utilCrear-->>vistaCrear: Muestra alerta de error
            vistaCrear-->>Usuario: Muestra mensaje de error
            end
        else Fórmula generada correctamente
            utilCrear-->>vistaCrear: Muestra previsualización
            Usuario->>vistaCrear: Click en "Guardar fórmula"
            vistaCrear->>utilCrear: procesarFormula()
            utilCrear->>utilCrear: Valida nombre, unicidad, longitud, campos
            alt Nombre inválido o repetido
                rect Lightcoral
                utilCrear-->>vistaCrear: Muestra alerta de error
                vistaCrear-->>Usuario: Muestra mensaje de error
                end
            else Fórmula válida
                utilCrear->>backend: guardarFormula(nombre, formula)
                alt Guardado exitoso
                    rect Lightgreen
                    backend-->>utilCrear: { ok: true }
                    utilCrear-->>vistaCrear: Muestra éxito y redirige a listado
                    vistaCrear-->>Usuario: Muestra mensaje de éxito
                    end
                else Error al guardar (API/backend)
                    rect Lightcoral
                    backend-->>utilCrear: { ok: false, mensaje }
                    utilCrear-->>vistaCrear: Muestra alerta de error
                    vistaCrear-->>Usuario: Muestra mensaje de error
                    end
                else Error inesperado (excepción)
                    rect Lightcoral
                    backend--x utilCrear: Excepción/Error
                    utilCrear-->>vistaCrear: Muestra alerta de error
                    vistaCrear-->>Usuario: Muestra mensaje de error
                    end
                end
            end
        end
    end
    deactivate vistaCrear
    deactivate Usuario
```
#### Segunda Parte (Backend Desacoplado)

```mermaid
sequenceDiagram
    actor Usuario
    participant UI as Electron
    participant app as app.js
    participant ruta as formulas/rutas/definirFormula.ruta.js
    participant middleware1 as util/middlewares/middlewareAutenticacion.js
    participant middleware2 as util/middlewares/middlewarePermisos.js
    participant controlador as formulas/controladores/definirFormulaControlador.js
    participant repo as formulas/data/repositorios/definirFormulaRepositorio.js
    participant modelo as formulas/data/modelos/definirFormulaModelo.js
    participant bd as util/servicios/bd.js

    activate Usuario
    Usuario->>UI: Click en "Definir fórmula"
    activate UI
    UI->>app: POST /formulas/definirFormula (datos fórmula)
    app->>ruta: /definirFormula
    ruta->>middleware1: verificarToken
    alt Token inválido
        rect Lightcoral
        middleware1-->>ruta: 401 { mensaje: "Token no válido" }
        ruta-->>app: 401
        app-->>UI: Muestra error de autenticación
        UI-->>Usuario: Mensaje de error
        end
    else Token válido
        middleware1->>middleware2: verificarPermisos
        alt Permisos insuficientes
            rect Lightcoral
            middleware2-->>ruta: 403 { mensaje: "No tienes permisos para realizar esta acción" }
            ruta-->>app: 403
            app-->>UI: Muestra error de permisos
            UI-->>Usuario: Mensaje de error
            end
        else Permisos correctos
            middleware2->>controlador: definirFormula (datos)
            controlador->>repo: definirFormulaRepositorio (datos)
            repo->>modelo: definirFormulaModelo (datos)
            modelo->>bd: INSERT INTO formula ...
            alt Definición exitosa
                rect Lightgreen
                bd-->>modelo: { ok: true, id }
                modelo-->>repo: { ok: true, id }
                repo-->>controlador: { ok: true, id }
                controlador-->>ruta: { ok: true, mensaje: "Fórmula definida con éxito" }
                ruta-->>app: 200 { ok: true, mensaje }
                app-->>UI: Muestra mensaje de éxito
                UI-->>Usuario: Mensaje de éxito
                end
            else Error de validación o negocio
                rect Lightcoral
                bd-->>modelo: { ok: false, mensaje }
                modelo-->>repo: { ok: false, mensaje }
                repo-->>controlador: { ok: false, mensaje }
                controlador-->>ruta: 400 { ok: false, mensaje }
                ruta-->>app: 400
                app-->>UI: Muestra mensaje de error
                UI-->>Usuario: Mensaje de error
                end
            else Error inesperado
                rect Lightcoral
                bd--x modelo: Excepción/Error
                modelo--x repo: Error
                repo--x controlador: Error
                controlador-->>ruta: 500 { ok: false, mensaje: "Error de servidor" }
                ruta-->>app: 500
                app-->>UI: Muestra mensaje de error
                UI-->>Usuario: Mensaje de error
                end
            end
        end
    end
    deactivate UI
    deactivate Usuario
```

### Mockup

![Mockup](./mockups/MockupCrearFormula.png)


![Mockup](./mockups/MockupFormulas3.png)


![Mockup](./mockups/MockupFormulas2.png)


### Pruebas Unitarias 

#### [https://docs.google.com/spreadsheets/d/1W-JW32dTsfI22-Yl5LydMhiu-oXHH_xo3hWvK6FHeLw/edit?gid=1643463360#gid=1643463360](https://docs.google.com/spreadsheets/d/1W-JW32dTsfI22-Yl5LydMhiu-oXHH_xo3hWvK6FHeLw/edit?gid=1643463360#gid=1643463360)
---

### Pull Request
[https://github.com/CodeAnd-Co/App-Local-TracTech/pull/38](https://github.com/CodeAnd-Co/App-Local-TracTech/pull/38)
