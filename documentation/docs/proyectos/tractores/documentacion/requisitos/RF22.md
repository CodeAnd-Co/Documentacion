---
title: "RF22: Usuario guarda fórmula."  
sidebar_position: 23
---

# RF22: Usuario guarda fórmula.

### Historia de Usuario

Yo como usuario quiero guardar una fórmula matemática/comercial personalizada que pueda aplicarse en futuras tablas, filtrar datos, generar reportes y mostrar información relevante para la toma de decisiones, sin necesidad de reescribir expresiones complejas manualmente cada vez.

  **Precondiciones:**
  - Es necesario haber cargado un archivo Excel.

  **Criterios de Aceptación:**
  
  - El usuario debe de poder guardar fórmulas con variables modificables.
  - La fórmula guardada debe de estar accesible en la lista de fórmulas disponibles.
  - Los campos de texto evitan inyecciones de código.
  - El límite de caracteres para la fórmula es de 512.
  - El límite de caracteres para el nombre es de 50.
  - El sistema debe permitir anidar fórmulas (fórmulas dentro de fórmulas) hasta un máximo de 10 antes de perder legibilidad.
  - El sistema debe mostrar un mensaje de éxito al crear la fórmula.
  - El sistema debe monstrar un mensaje de error dependiendo de lo falló.


---

### Diagrama de Secuencia
```mermaid
sequenceDiagram
    actor Usuario
    participant Vista as crearFormula.ejs
    participant utilFormula as crearFormula.js
    participant Caso as crearFormula.js
    participant API as formulaApi.js
    participant server as Backend desacoplado

    activate Usuario
    Usuario->>Vista: Ingresa fórmula (nombre, expresión)

    activate Vista
    Vista->>utilFormula: POST /formulas
    deactivate Vista

    activate utilFormula
    utilFormula->>Caso: guardarFormula(formulaData)
    deactivate utilFormula

    activate Caso
    Caso->>Caso: Validar fórmula localmente

    alt Fórmula válida
        Caso-)API: guardarFormula (nombre, formula)
        deactivate Caso

        activate API
        API-)server: guardarFormula(nombre, formula, token)
        activate server
        rect LightGreen
            server -->> API: HTTP 200: fórmula guardada
            deactivate server
            API -->> Caso: response('éxito')
            deactivate API
            activate Caso
            Caso -->> utilFormula: response('éxito')
            deactivate Caso
            activate utilFormula
            utilFormula -->> Vista: mostrar éxito
            deactivate utilFormula
            activate Vista
            Vista ->> Usuario: Mensaje: fórmula guardada correctamente
            deactivate Vista
        end
    end

    %% === FLUJOS ALTERNOS ===
    alt Expresión inválida localmente
        rect rgb(255, 77, 77)
            Caso -->> utilFormula: Error: expresión inválida
            activate utilFormula
            utilFormula -->> Vista: mostrar error
            deactivate utilFormula
            activate Vista
            Vista ->> Usuario: Mensaje: la expresión no es válida
            deactivate Vista
        end
    else Nombre duplicado
        rect rgb(255, 77, 77)
            server -->> API: Error 409: nombre duplicado
            activate API
            API -->> Caso: Error: nombre duplicado
            deactivate API
            activate Caso
            Caso -->> utilFormula: Error: nombre duplicado
            deactivate Caso
            activate utilFormula
            utilFormula -->> Vista: mostrar error
            deactivate utilFormula
            activate Vista
            Vista ->> Usuario: Mensaje: el nombre ya existe
            deactivate Vista
        end
    else Falla de conexión
        rect rgb(255, 77, 77)
            server -->> API: Error 500 / Timeout
            activate API
            API -->> Caso: Error de red
            deactivate API
            activate Caso
            Caso -->> utilFormula: Error al conectar con backend
            deactivate Caso
            activate utilFormula
            utilFormula -->> Vista: mostrar error
            deactivate utilFormula
            activate Vista
            Vista ->> Usuario: Mensaje: no se pudo guardar la fórmula
            deactivate Vista
        end
    end
    deactivate Usuario
```

### Segunda parte
```mermaid
sequenceDiagram
    participant API
    participant RutaIndice as formulasIndice.ruta.js
    participant Ruta as guardarFormula.ruta.js
    participant Controlador as guardarFormulaControlador.js
    participant Repositorio as guardarFormulaRepositorio.js
    participant Modelo as guardarFormulaModelo.js
    participant DB as MySQL

    activate API
    API->>RutaIndice: POST /formulas

    activate RutaIndice
    RutaIndice->>Ruta: POST /formulas
    deactivate RutaIndice

    activate Ruta
    Ruta->>Controlador: guardarFormula(formulaData)
    deactivate Ruta

    activate Controlador
    Controlador-)Repositorio: guardarFormula(formulaData)

    activate Repositorio
    Repositorio-)Modelo: insert(formulaData)
    activate Modelo
    rect LightGreen
        Modelo-)DB: query(?,?)
        activate DB
        DB-->>Modelo: response('OK')
        deactivate DB
        Modelo -->> Repositorio: response('OK')
        deactivate Modelo
        Repositorio -->> Controlador: fórmula guardada
        deactivate Repositorio
        Controlador -->> Ruta: response('éxito')
        deactivate Controlador
        activate Ruta
        Ruta -->> API: HTTP 200: fórmula guardada
        deactivate Ruta
    end

    %% === FLUJOS ALTERNOS ===
    alt Nombre duplicado
        rect rgb(255, 77, 77)
            Modelo -->> Repositorio: Error: nombre duplicado
            Repositorio -->> Controlador: Error 409: nombre duplicado
            Controlador -->> Ruta: Error 409: nombre duplicado
            activate Ruta
            Ruta -->> API: Error 409: nombre duplicado
            deactivate Ruta
        end
    else Falla en repositorio
        rect rgb(255, 77, 77)
            Repositorio -->> Controlador: Error 500: base de datos inaccesible
            Controlador -->> Ruta: Error 500: fallo en repositorio
            activate Ruta
            Ruta -->> API: Error 500: fallo en repositorio
            deactivate Ruta
        end
    else Falla en el controlador
        rect rgb(255, 77, 77)
            Controlador --x Ruta: Error 500: fallo interno en el procesamiento
            activate Ruta
            Ruta -->> API: Error 500: fallo interno del servidor
            deactivate Ruta
        end
    end
    deactivate API
```
---

### Mockup

![Mockup](./mockups/MockupRF22.png)
> *Descripción*: El mockup representa la interfaz del sistema donde el usuario puede crear y guardar una fórmula.


![Mockup](./mockups/MockupFormulas3.png)


![Mockup](./mockups/MockupFormulas2.png)

> *Descripción*: El mockup representa la interfaz del sistema donde el usuario ya a seleccionado una formula.

---

### Pruebas Unitarias 
  - [Pruebas](https://docs.google.com/spreadsheets/d/1W-JW32dTsfI22-Yl5LydMhiu-oXHH_xo3hWvK6FHeLw/edit?gid=1362976154#gid=1362976154)

### Pull Request
[https://github.com/CodeAnd-Co/App-Local-TracTech/pull/38](https://github.com/CodeAnd-Co/App-Local-TracTech/pull/38)